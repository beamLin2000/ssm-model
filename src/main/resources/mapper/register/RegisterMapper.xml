<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gxa.mapper.register.RegisterMapper">

    <resultMap id="registerCondition" type="com.gxa.entity.registration.RegisterMsg">
        <id property="registrationForm" column="挂号单号"></id>
        <result property="name" column="patient_name"></result>
        <result property="gender" column="patient_gender"></result>
        <result property="phoneNo" column="patient_phone"></result>
        <result property="attendingDoctor" column="接诊医生"></result>
        <result property="receptionTime" column="接诊时间"></result>
        <result property="willPaid" column="实收金额"></result>
        <result property="amountPaid" column="实收金额"></result>
        <result property="status" column="就诊状态"></result>
    </resultMap>
    <resultMap id="registerUpdateMsg" type="com.gxa.entity.registration.RegisterMsgUpdate">
        <id property="registrationForm" column="挂号单号" jdbcType="VARCHAR"></id>
        <result property="willPaid" column="实收金额"></result>
        <result property="insurancePayment" column="医保支付" ></result>
        <result property="amountPaid" column="实收金额" ></result>
        <result property="payMethod" column="支付方式" ></result>
        <result property="changeMoney" column="找零" ></result>
        <result property="registrationDateTime" column="创建时间" ></result>
        <result property="receptionType" column="接诊类型" ></result>
        <result property="attendingDoctor" column="接诊医生" ></result>
        <result property="tolCollector" column="接诊医生"></result>
        <result property="registrationFee" column="挂号费" ></result>
        <result property="consultationFee" column="诊疗费" ></result>
        <result property="name" column="patient_name" ></result>
        <result property="cardNo" column="patient_card" ></result>
        <result property="age" column="patient_age" ></result>
        <result property="birthDay" column="patient_birthday" ></result>
        <result property="gender" column="patient_gender" ></result>
        <result property="phoneNo" column="patient_phone" ></result>
        <result property="idNo" column="patient_documents" ></result>
        <result property="loc" column="patient_address" ></result>
        <result property="remarks" column="patient_remark" ></result>
    </resultMap>
    <insert id="saveCharge" parameterType="com.gxa.entity.registration.Register">
        insert into charge(挂号单号,医保支付,实收金额,找零,支付方式,收款备注,创建时间)
        values (#{registrationForm},#{medicalInsurancePayment},#{amountPaid},#{changeMoney},#{paymentMethod},
            #{collectionRemarks},#{registrationDateTime})
    </insert>
    <insert id="saveRegister" parameterType="com.gxa.entity.registration.Register">
        insert into register(挂号单号,接诊类型,接诊医生,挂号费,诊疗费,挂号日期,挂号员,就诊状态)
        values (#{registrationForm},#{receptionType},#{attendingDoctor},#{registrationFee},#{consultationFee},
                #{registrationDate},#{registrationClerk},#{status})
    </insert>
    <insert id="savePatient" parameterType="com.gxa.entity.registration.Register">
        insert into patients(挂号单号,patient_name,patient_card,patient_age,patient_birthday,patient_gender,patient_phone,patient_documents,
                            patient_address,patient_remark)
        values (#{registrationForm},#{name},#{cardNo},#{age},#{birthDay},#{gender},#{phoneNo},#{idNo},#{loc},#{remarks})
    </insert>
    <update id="updateRegister" parameterType="com.gxa.entity.registration.RegisterMsgUpdate">
        UPDATE register
        SET 接诊类型=#{receptionType},接诊医生=#{attendingDoctor}
        WHERE 挂号单号=#{registrationForm}
    </update>
    <update id="updatePatient" parameterType="com.gxa.entity.registration.RegisterMsgUpdate">
        UPDATE patients
        SET patient_age=#{age},patient_birthday=#{birthDay},patient_gender=#{gender},
            patient_phone=#{phoneNo},patient_documents=#{idNo},patient_address=#{loc},
            patient_remark=#{remarks}
        WHERE 挂号单号=#{registrationForm}

    </update>
    <delete id="deleteCharge">
        DELETE FROM charge WHERE 挂号单号=#{registrationForm}
    </delete>
    <delete id="deleteRegister">
        DELETE FROM register WHERE 挂号单号=#{registrationForm}
    </delete>
    <delete id="deletePatient">
        DELETE FROM patients WHERE 挂号单号=#{registrationForm}
    </delete>
    <select id="query" resultMap="registerCondition" parameterType="com.gxa.entity.registration.RegisterQueryCondition">
        select c.实收金额,p.patient_name,p.patient_gender,p.patient_age,p.patient_phone,r.接诊医生,r.挂号单号
        from charge c,patients p,register r
        <where>
            c.挂号单号 = p.挂号单号 and p.挂号单号 = r.挂号单号
            <if test="attendingDoctor != null and attendingDoctor !=''">
            and r.接诊医生=#{attendingDoctor}
            </if>
           <if test="patientName !=null and patientName !=''">
               and p.patient_name=#{patientName}
           </if>
           <if test="visitStatus !=null and visitStatus !=''">
                and r.就诊状态=#{visitStatus}
           </if>
           <if test="startTime != null and startTime !=''">
                and r.挂号日期>#{startTime}
           </if>
           <if test="endTime != null and endTime !=''">
               and #{endTime}>r.挂号日期
           </if>
        </where>
        limit 10
    </select>
    <select id="toUpdate" resultMap="registerUpdateMsg" parameterType="string">
        select r.挂号单号,c.实收金额,c.医保支付,c.支付方式,c.找零,c.创建时间,r.接诊类型,
               r.接诊医生,r.挂号费,r.诊疗费,p.patient_name,p.patient_card,p.patient_age
                ,p.patient_birthday,p.patient_gender,p.patient_phone,p.patient_documents
                ,p.patient_address,p.patient_remark
        from charge c,patients p,register r
        where c.挂号单号 = p.挂号单号
          and p.挂号单号 = r.挂号单号 and r.挂号单号=#{registrationForm}
    </select>
    <select id="count" resultType="java.lang.Integer" parameterType="com.gxa.entity.registration.RegisterQueryCondition">
        SELECT COUNT(c.挂号单号)
        FROM charge c,patients p,register r
        <where>
            c.挂号单号 = p.挂号单号 and p.挂号单号 = r.挂号单号
            <if test="attendingDoctor != null and attendingDoctor !=''">
                and r.接诊医生=#{attendingDoctor}
            </if>
            <if test="patientName !=null and patientName !=''">
                and p.patient_name=#{patientName}
            </if>
            <if test="visitStatus !=null and visitStatus !=''">
                and r.就诊状态=#{visitStatus}
            </if>
            <if test="startTime != null and startTime !=''">
                and r.挂号日期>#{startTime}
            </if>
            <if test="endTime != null and endTime !=''">
                and #{endTime}>r.挂号日期
            </if>
        </where>
    </select>
</mapper>